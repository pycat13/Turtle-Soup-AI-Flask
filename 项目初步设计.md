# 海龟汤互动网站 — 技术设计文档

> 团队规模：前端 1 人 + 后端 2 人
> 技术栈限制：Flask（后端），HTML + CSS + JS（前端），允许使用 Ajax / Fetch 调用 REST API
> 目标：实现一个支持海龟汤谜题交互、可玩三种模式、带用户系统、记分板、后台管理的完整网站。

---

# 1. 系统整体架构设计

系统采用 **前后端分离**：

## 1.1 前端（静态资源）

* 技术：HTML、CSS、Vanilla JS
* 运行方式：Nginx / Flask 静态资源也可（根据部署情况）
* 通过 Ajax 调用 Flask 提供的 RESTful API
* 负责页面渲染与交互逻辑

## 1.2 后端（Flask）

主要模块：

1. 用户认证模块（登录、注册）
2. 海龟汤题目管理模块（增删查改）
3. 游戏逻辑模块（海龟汤推理问答）
4. 积分系统（记录游戏得分）
5. 管理员后台系统（题目管理、用户管理）
6. API 层（RESTful）

## 1.3 数据库（推荐 SQLite）

核心表：

* users
* puzzles（海龟汤题）
* puzzle_answers（标准答案）
* game_sessions（记录游戏过程）
* scores（得分）
* admin_logs（管理员操作日志）

---

# 2. 核心页面与功能模块

## 2.1 首页 `/`

内容：

* 题目列表（卡片式展示）
* 按钮：记分板（Scoreboard）
* 按钮：设置（Settings）
* 登录状态显示（已登录 / 未登录）

行为：

* 点击某题 → 进入**选择游玩方式**页面

---

## 2.2 选择游玩方式页面 `/play/<puzzle_id>/mode`

三种模式：

1. **自由提问模式**
   无限制，用户自由问答直到破案。

2. **限时模式**
   有倒计时，如 5 分钟；过时则失败。

3. **限制问题数量模式**
   如最多问 20 个问题；达到上限则游戏结束。

---

## 2.3 游戏界面 `/play/<puzzle_id>?mode=xxx`

展示内容：

* 左侧：AI 对话窗口（模拟海龟汤提问）
* 右侧：当前剩余时间 / 剩余次数（根据模式）
* 底部：输入栏 + 发送按钮
* 退出 / 投降（显示标准答案）

后台使用海龟汤 AI 模型回答：

* 用户问的问题通过 AJAX POST 到 `/api/play/chat`
* 后端根据题目逻辑生成回答

---

## 2.4 登录 / 注册页面

* 登录后才能成绩计入排行榜

API：

* `/api/auth/login`
* `/api/auth/register`
* `/api/auth/logout`

---

## 2.5 记分板页面 `/scoreboard`

数据项：

* 用户名
* 总分
* 最近游戏时间
* 最佳成绩

---

## 2.6 管理后台 `/admin`

包含：

* 题目管理（增删查改）
* 用户管理
* 查看操作日志

管理员权限控制：

* 使用 JWT 或 Session + 权限字段（is_admin）

---

# 3. RESTful API 设计（重点）

API 前缀：`/api`

---

## 3.1 用户系统（auth）

| 方法   | 路径                   | 功能            |
| ---- | -------------------- | ------------- |
| POST | `/api/auth/register` | 用户注册          |
| POST | `/api/auth/login`    | 用户登录          |
| POST | `/api/auth/logout`   | 用户登出          |
| GET  | `/api/auth/me`       | 获取当前用户信息（需登录） |

示例：

```json
POST /api/auth/login
{
    "username": "alice",
    "password": "123456"
}
```

---

## 3.2 题目（puzzles）

| 方法     | 路径                  | 功能                  |
| ------ | ------------------- | ------------------- |
| GET    | `/api/puzzles`      | 获取所有题目列表（仅展示简介）     |
| GET    | `/api/puzzles/<id>` | 获取完整题目（仅对管理员提供标准答案） |
| POST   | `/api/puzzles`      | 创建题目（管理员）           |
| PUT    | `/api/puzzles/<id>` | 修改题目（管理员）           |
| DELETE | `/api/puzzles/<id>` | 删除题目（管理员）           |

---

## 3.3 游戏（game / play）

### 开局准备

| 方法   | 路径                | 功能               |
| ---- | ----------------- | ---------------- |
| POST | `/api/play/start` | 开始游戏（记录 session） |

body 示例：

```json
{
    "puzzle_id": 2,
    "mode": "limited_questions"
}
```

返回：

* session_id
* 初始状态

### AI 问答

| 方法   | 路径                 | 功能            |
| ---- | ------------------ | ------------- |
| POST | `/api/play/chat`   | 用户问一句，AI 回答一句 |
| POST | `/api/play/finish` | 用户结束游戏（胜利/失败） |

`/api/play/chat` 示例：

```json
{
    "session_id": "abcd1234",
    "question": "他死的时候是在船上吗？"
}
```

返回 AI 回答。

---

## 3.4 积分系统（scores）

| 方法   | 路径                   | 功能     |
| ---- | -------------------- | ------ |
| GET  | `/api/scores`        | 获取排行榜  |
| POST | `/api/scores/submit` | 提交一局得分 |

---

## 3.5 管理后台（admin）

路径前缀 `/api/admin/*` 仅管理员可用。

| 方法  | 路径                 | 功能     |
| --- | ------------------ | ------ |
| GET | `/api/admin/users` | 查看所有用户 |
| GET | `/api/admin/logs`  | 查看操作日志 |

---

# 4. 数据库设计（详表）

## 4.1 users 表

| 字段            | 类型       | 说明    |
| ------------- | -------- | ----- |
| id            | int PK   | 用户 ID |
| username      | varchar  | 账户名   |
| password_hash | varchar  | 哈希密码  |
| is_admin      | bool     | 管理员标识 |
| created_at    | datetime | 创建时间  |

---

## 4.2 puzzles 表

| 字段              | 类型       | 说明      |
| --------------- | -------- | ------- |
| id              | int PK   | 题目 ID   |
| title           | varchar  | 题目标题    |
| description     | text     | 给用户看的故事 |
| standard_answer | text     | 海龟汤谜底   |
| created_by      | int FK   | 管理员 ID  |
| created_at      | datetime | 创建时间    |

---

## 4.3 game_sessions 表

| 字段         | 类型       | 说明           |
| ---------- | -------- | ------------ |
| id         | string   | session uuid |
| puzzle_id  | int      | 题目 ID        |
| user_id    | int      | 用户 ID        |
| mode       | varchar  | 游戏模式         |
| start_time | datetime | 开始时间         |
| end_time   | datetime | 结束时间         |
| status     | varchar  | success/fail |

---

## 4.4 scores 表

| 字段         | 类型       | 说明 |
| ---------- | -------- | -- |
| id         | int PK   |    |
| user_id    | int      |    |
| puzzle_id  | int      |    |
| score      | int      | 得分 |
| created_at | datetime |    |

---

# 5. 前端结构设计

目录示例：

```
/frontend
  /assets
    /css
    /js
    /img
  index.html
  login.html
  register.html
  play_mode.html
  play.html
  scoreboard.html
  admin.html
```

### JS 主要模块

```
/js
  api.js          # 封装 ajax 请求
  auth.js         # 登录注册逻辑
  puzzles.js      # 获取题目列表
  play.js         # 游戏对话逻辑
  scoreboard.js   # 排行榜
  admin.js        # 后台管理
```

---

# 6. 后端结构设计（Flask）

建议使用 Blueprint + Service + Model 结构

```
/backend
  app.py
  /api
    auth.py
    puzzles.py
    play.py
    scores.py
    admin.py
  /models
    user.py
    puzzle.py
    session.py
    score.py
  /services
    auth_service.py
    game_service.py
    puzzle_service.py
    ai_service.py
  /utils
    db.py
    jwt.py
    error_handler.py
```

---

# 7. 游戏逻辑（AI 回答规则）

海龟汤回答应遵循：

* 只能回答 “是 / 否 / 无关 / 不方便透露”
* 如果用户直接猜谜底，判断对错
* 模式控制（提问次数、时间）在后端完成

---

# 8. 权限设计

* 普通用户：玩游戏、查看排行榜、修改个人信息
* 管理员：题目增删查改、查看用户、查看日志

权限在 Flask 中中间件处理：

* 使用装饰器 `@admin_required`
* 使用 `@login_required` 控制登录访问

---

# 10. 开发流程建议

建议两周（10 天工作日）开发周期：

### **Day 1-2**

→ 后端项目框架、数据库搭建
→ 前端界面原型设计

### **Day 3-6**

→ 后端 API 编写
→ 前端页面实现

### **Day 7-8**

→ API 对接
→ 游戏逻辑完善

### **Day 9-10**

→ 测试与优化
→ 上线部署
